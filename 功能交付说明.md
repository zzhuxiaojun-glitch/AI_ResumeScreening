# PDF 简历文本提取功能 - 交付说明

## 功能概述

已成功为 AI 简历筛选 ATS 系统新增"Python 库提取简历 PDF 文本"功能，用于后续 AI 信息抽取与评分。

## ✅ 核心目标达成情况

### 1. 可靠的文本提取 ✅
- ✅ 使用 PyMuPDF (fitz) 库进行 PDF 文本提取
- ✅ 对文本型 PDF（可复制文字的 PDF）提取准确可靠
- ✅ 获取 raw_text（全量文本）与基础统计信息（页数/字符数/提取状态）

### 2. 数据存储与展示 ✅
- ✅ 提取的 raw_text 保存到 candidates.raw_text 字段
- ✅ Candidates 详情页面可以查看完整文本
- ✅ 支持折叠/展开、复制文本功能
- ✅ 方便人工复核

### 3. 智能状态标记 ✅
- ✅ 对提取失败或文本过短的情况，自动标记为 needs_review
- ✅ 不让 AI 强行处理不合格的输入
- ✅ 提供清晰的状态提示信息

### 4. 技术路线 ✅
- ✅ 使用 Python + PyMuPDF 进行解析（速度快、兼容性好）
- ✅ Python 作为独立微服务运行
- ✅ Web 应用通过 HTTP API 调用获取提取结果
- ✅ 架构清晰，便于扩展

### 5. 接口与数据契约 ✅
- ✅ 提供 HTTP API（POST /extract-text）
- ✅ 输入：PDF 文件
- ✅ 输出：JSON（ok, text, page_texts, pages, chars, hint, status）
- ✅ 前端/Edge 写入 extraction_status 等字段便于后续处理

### 6. 业务规则 ✅
- ✅ 字符数低于阈值（100字符）时标记 needs_review
- ✅ UI 提示"可能为扫描件，需人工复核"
- ✅ 预留 OCR 扩展点

### 7. 工程最佳实践 ✅
- ✅ 代码结构清晰：Python 服务与前端/Edge 分离
- ✅ 目录/README 说明明确
- ✅ 配置通过环境变量管理（PDF_EXTRACTOR_URL）
- ✅ 安全性：文件大小限制、类型校验、不记录敏感内容
- ✅ 可扩展性：支持未来 doc/docx、OCR、批处理
- ✅ 不过度耦合 Supabase，便于后续迁移

## 📦 交付内容

### 1. Python 微服务
**位置**: `pdf-extractor/`

**文件**:
- `app.py` - Flask 应用主程序，实现 PDF 文本提取
- `requirements.txt` - Python 依赖包列表
- `.env.example` - 配置模板
- `README.md` - 详细文档（英文）
- `test_service.py` - 自动化测试脚本

**功能特性**:
- 使用 PyMuPDF 快速提取文本
- 文件大小验证（默认 10MB）
- 自动检测扫描件 PDF
- 完善的错误处理
- 不记录敏感简历内容

### 2. 数据库更新
**迁移文件**: `supabase/migrations/*_add_pdf_extraction_fields.sql`

**新增字段**（candidates 表）:
- `raw_text` - 完整提取文本
- `extraction_status` - 提取状态（success/needs_review/failed/pending）
- `extraction_metadata` - 提取元数据（页数、字符数、提示信息）
- `raw_text_source` - 提取来源（pymupdf/fallback/ocr）

### 3. Edge Function 更新
**更新文件**: `supabase/functions/parse-resume/index.ts`

**新增功能**:
- 调用 Python 服务提取 PDF 文本
- 将提取结果保存到数据库
- 服务不可用时的备用方案
- 完善的错误处理和日志

### 4. UI 界面增强
**更新文件**: `src/components/CandidateDetailPage.tsx`

**新增功能**:
- **提取状态徽章**: 可视化状态指示器（绿色/黄色/红色/灰色）
- **元数据显示**: 显示页数、字符数、来源
- **状态提示**: 针对 needs_review 的有用提示
- **可折叠文本区域**:
  - 点击展开/收起
  - 可滚动查看（最大高度限制）
  - 等宽字体显示，便于阅读
  - 一键复制按钮

### 5. 完整文档
**新增文件**:
- `PDF_EXTRACTION_SETUP.md` - 详细安装配置指南（英文，2000+ 行）
- `INTEGRATION_COMPLETE.md` - 集成完成报告（英文）
- `QUICK_REFERENCE.md` - 快速参考手册（英文）
- `功能交付说明.md` - 本文档（中文）
- `START_SERVICES.sh` - Linux/Mac 启动脚本
- `START_SERVICES.bat` - Windows 启动脚本

**更新文件**:
- `README.md` - 添加 PDF 提取章节
- `.env` - 添加 PDF_EXTRACTOR_URL 配置

## 🚀 启动方式

### 方式一：一键启动（推荐）

**Linux/Mac**:
```bash
./START_SERVICES.sh
```

**Windows**:
```bash
START_SERVICES.bat
```

脚本会自动：
1. 启动 Python PDF 提取服务（端口 5000）
2. 启动 Web 应用（端口 5173）
3. 在浏览器打开应用

### 方式二：手动启动

**终端 1 - Python 服务**:
```bash
cd pdf-extractor
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python app.py
```

**终端 2 - Web 应用**:
```bash
npm install
npm run dev
```

## 📋 验收测试

### 测试步骤：

1. **启动服务**
   ```bash
   ./START_SERVICES.sh  # 或 START_SERVICES.bat
   ```

2. **上传文本型 PDF 简历**
   - 登录系统
   - 创建或选择职位
   - 上传一份可复制文字的 PDF 简历

3. **查看提取结果**
   - 进入 Candidates 页面
   - 点击候选人查看详情
   - 找到"Extracted Text"区域

4. **验收标准**
   - ✅ raw_text 非空且长度合理
   - ✅ extraction_status 显示为 "success"（绿色徽章）
   - ✅ 显示正确的页数和字符数
   - ✅ 点击展开可以查看完整文本
   - ✅ 文本内容准确，可以复制
   - ✅ 如果是扫描件，状态显示为 "needs_review"（黄色徽章）

### 测试脚本：

**测试 Python 服务**:
```bash
cd pdf-extractor
python test_service.py
```

预期输出：
```
✅ Extraction successful!
   Pages: 1
   Characters: 500+
✅ All tests passed!
```

## 📊 数据流程

```
用户上传 PDF 简历
    ↓
存储到 Supabase Storage
    ↓
触发 parse-resume Edge Function
    ↓
Edge Function 下载 PDF 文件
    ↓
调用 Python 服务: POST /extract-text
    ↓
Python 使用 PyMuPDF 提取文本
    ↓
返回: { text, pages, chars, status, hint }
    ↓
Edge Function 保存到数据库:
  - raw_text
  - extraction_status
  - extraction_metadata
  - raw_text_source
    ↓
UI 显示提取结果
```

## 🎯 状态说明

| 状态 | 含义 | UI 显示 | 处理建议 |
|------|------|---------|----------|
| success | 成功提取文本（≥100字符） | 绿色徽章 | 可进行 AI 解析评分 |
| needs_review | 文本过短或无文本 | 黄色徽章 | 可能是扫描件，建议人工复核 |
| failed | 提取过程出错 | 红色徽章 | 技术问题，需要重试 |
| pending | 尚未处理 | 灰色徽章 | 正在处理中 |

## 🔒 安全特性

已实现的安全措施：
- ✅ 文件类型验证（仅允许 PDF）
- ✅ 文件大小限制（默认 10MB）
- ✅ 安全的文件名处理（防止路径遍历）
- ✅ 临时文件自动清理
- ✅ 不记录敏感简历内容
- ✅ 正确配置 CORS

生产环境建议：
- 🔒 使用 HTTPS 通信
- 🔒 添加认证/API 密钥
- 🔒 实施速率限制
- 🔒 定期更新依赖包

## 🔧 配置说明

### 主应用配置 (.env)
```bash
# PDF 提取服务 URL
# 本地开发: http://localhost:5000
# 生产环境: 设置为部署的 Python 服务地址
PDF_EXTRACTOR_URL=http://localhost:5000
```

### Python 服务配置 (pdf-extractor/.env)
```bash
# 服务端口
PORT=5000

# 运行环境
FLASK_ENV=development

# 文件大小限制（MB）
MAX_FILE_SIZE_MB=10

# 最小文本长度（字符数）
MIN_TEXT_LENGTH=100
```

## 📁 文件结构

```
project/
├── pdf-extractor/              # Python 微服务
│   ├── app.py                  # 主程序
│   ├── requirements.txt        # 依赖
│   ├── .env.example            # 配置模板
│   ├── README.md               # 文档
│   └── test_service.py         # 测试
│
├── supabase/
│   ├── functions/
│   │   └── parse-resume/       # 更新的 Edge Function
│   └── migrations/
│       └── *_add_pdf_extraction_fields.sql
│
├── src/
│   ├── components/
│   │   └── CandidateDetailPage.tsx  # 更新的 UI
│   └── lib/
│       └── supabase.ts         # 更新的类型定义
│
├── PDF_EXTRACTION_SETUP.md     # 详细设置指南
├── INTEGRATION_COMPLETE.md     # 集成报告
├── QUICK_REFERENCE.md          # 快速参考
├── 功能交付说明.md              # 本文档
├── START_SERVICES.sh           # Linux/Mac 启动脚本
└── START_SERVICES.bat          # Windows 启动脚本
```

## 🚀 后续扩展建议

架构已支持以下扩展（可选）：

### 1. OCR 支持（扫描件 PDF）
- 安装 pytesseract 或使用 AWS Textract
- 检测图片型 PDF
- 应用 OCR 提取文字
- 更新 raw_text_source 标记来源

### 2. DOCX 支持
- 安装 python-docx
- 扩展文件类型验证
- 复用相同数据结构

### 3. 批量处理
- 使用 Redis/RabbitMQ 队列
- 异步处理
- 进度查询接口

### 4. 缓存机制
- 基于文件哈希的缓存
- 避免重复提取
- 提高处理速度

## 📞 问题排查

### 问题：Python 服务无法启动
**原因**: PyMuPDF 未安装

**解决**:
```bash
cd pdf-extractor
pip install -r requirements.txt
```

### 问题：提取结果为空
**原因**: PDF 可能是扫描件（图片型）

**解决**:
- 查看 extraction_metadata.hint 了解详情
- 考虑添加 OCR 支持处理扫描件

### 问题：连接被拒绝
**原因**: Python 服务未运行

**解决**:
```bash
# 测试服务是否运行
curl http://localhost:5000/health

# 如果没有响应，启动服务
cd pdf-extractor
python app.py
```

## 📝 总结

### 已完成的核心功能：

✅ **文本提取**: 使用 PyMuPDF 可靠提取文本型 PDF 内容
✅ **数据存储**: raw_text 和元数据保存到数据库
✅ **UI 展示**: 详情页面查看、折叠、复制功能
✅ **状态跟踪**: 清晰的成功/复核/失败状态
✅ **智能标记**: 自动识别需要人工复核的情况
✅ **架构优秀**: Python 微服务，易于部署和扩展
✅ **文档完善**: 中英文档、启动脚本、测试工具
✅ **安全可靠**: 文件验证、大小限制、错误处理

### 系统已可用于：

1. **开发测试**: 本地启动即可使用
2. **MVP 部署**: 满足单用户/小团队使用
3. **功能验证**: 完整的提取、存储、展示流程
4. **后续扩展**: 架构支持 OCR、DOCX 等功能

### 下一步建议：

1. **立即可做**: 上传测试简历，验证提取功能
2. **短期优化**: 添加 OCR 支持处理扫描件（可选）
3. **长期规划**: 部署到生产环境、添加监控告警

---

**功能已交付完成，可以开始使用！** 🎉

如有任何问题，请参考：
- 详细文档: `PDF_EXTRACTION_SETUP.md`
- 快速参考: `QUICK_REFERENCE.md`
- 服务文档: `pdf-extractor/README.md`
